<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    </head>
    <body>
        <div id='app'>
            <div id='chatBox'>
                <div id='msgBox' style="overflow-y: scroll;height: calc(100% - 150px)"></div>
                <div id='sendBox' style="position: absolute; bottom: 0; height: 150px;">
                    <textarea v-model='msg' rows="6" cols="40" onkeydown="if(event.keyCode==13){event.preventDefault(); v.send()}"></textarea>
                    <button v-on:click='send'>{{text}}</button>
                </div>
            </div>
        </div>
    </body>

    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        var v = new Vue({
            el: '#app',
            created() {
                if(localStorage.getItem('name') == null){
                    let name = prompt('請輸入ID')
                    if(name == 'ADMIN'){
                        let password = prompt('請輸入Password')
                        axios('/opCheck?pass=' + password)
                        .then(res=> {
                            if(res.data == '1') {
                                this.name = name
                                localStorage.setItem('name', name)
                            }
                            else {
                                window.location.reload()
                            }
                        })
                    }
                    else{
                        this.name = name
                        localStorage.setItem('name', name)
                    }
                }
                else{
                    this.name = localStorage.getItem('name')
                }
                window.addEventListener('keypress', (key) => {
                    if(key.which == 13){
                        this.send()
                    }
                });
            },
            data: {
                text: "送出",
                name: "",
                msg: ""
            },
            methods: {
                send: function(){
                    if(this.msg.search('228922') != -1){
                        this.text = '委任你是不是沒被扁過'
                        this.msg = ""
                    }
                    if(this.msg && !this.msg.match(/^\s+$/)){
                        let date = new Date()
                        let time = date.getHours()+'時'+date.getMinutes()+'分 '

                        ws.send(JSON.stringify({command: "message", time: time, name: this.name, msg: this.msg}))
                        this.msg = ""
                    }
                }
            },
        })
    </script>
    <script>
        var ws = new WebSocket(location.origin.replace(/^http/, 'ws'))  
        var msgBox = document.getElementById('msgBox')

        ws.addEventListener('message', (res)=> {
            let data = JSON.parse(res.data)

            switch(data.command){
                case "regular":
                    break
                case "connect":
                    document.title = "在線人數: " + data.nums
                    break
                case "message":
                    let msgArea = document.createElement('pre')
                    let msgHeader = document.createElement('strong')
                    let msgText = document.createElement('span')

                    switch(data.name){
                        case "ADMIN":
                            msgArea.setAttribute('class', 'admin')
                            break
                        case v.name:
                            msgArea.setAttribute('class', 'me')
                            break
                        default:
                            msgArea.setAttribute('class', 'others')
                            break
                    }
                    msgHeader.innerText = data['name'] + ' 於 ' + data['time'] + '發表:\n'
                    msgText.innerText = data['msg'] + '\n'

                    msgArea.appendChild(msgHeader)
                    msgArea.appendChild(msgText)
                    msgBox.appendChild(msgArea)
                    msgBox.scrollTo(0, msgBox.scrollHeight);
                    break

            }
        })
        
        ws.addEventListener('close', ()=> {
            if(confirm('連線中斷')) window.location.reload()
        })
    </script>
    <script>
        setInterval(()=>{
            ws.send(JSON.stringify({command: "regular"}))
        }, 40000)
    </script>

    <style>
        .admin {
            background-color: rgba(215, 9, 35, 0.5);
        }
        .me {
            background-color: rgba(1, 185, 23, 0.5);
        }
        .others {
            background-color: rgba(35, 185, 239, 0.5);
        }
        textarea {
            resize: none; 
        }
        button {
            width: 140px;
            height: 50px;
        }
    </style>
</html>